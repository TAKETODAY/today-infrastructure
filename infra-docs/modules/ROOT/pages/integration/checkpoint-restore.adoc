[[checkpoint-restore]]
= JVM 检查点恢复 (Project CRaC)

Infra 框架支持 Project CRaC (Coordinated Restore at Checkpoint) 用于 JVM 检查点恢复。
该项目允许您在应用程序运行时的特定点创建其状态的快照（检查点），然后稍后从该状态恢复它。
这对于减少启动时间和预热时间非常有用。

[[checkpoint-restore-dependencies]]
== 依赖项

要使用 CRaC，您需要使用支持 CRaC 的 JDK（例如，Azul Zulu JDK 或 BellSoft Liberica JDK）。
您还需要在项目中包含 `org.crac:crac` 库。

[[checkpoint-restore-lifecycle]]
== 生命周期集成

Infra 框架与 CRaC 生命周期集成，以确保在检查点和恢复期间正确处理资源。
当触发检查点时，Infra 将：

1.  停止所有正在运行的 bean（实现 `Lifecycle` 接口）。
2.  关闭所有活动的上下文。
3.  调用任何注册的 CRaC 资源上的 `beforeCheckpoint()` 方法。

当从检查点恢复时，Infra 将：

1.  调用任何注册的 CRaC 资源上的 `afterRestore()` 方法。
2.  刷新并重新启动上下文。
3.  启动所有 bean。

[[checkpoint-restore-usage]]
== 用法

要触发检查点，您可以使用 JDK 提供的工具或 API。
例如，您可以使用 `jcmd` 命令：

[source,bash]
----
jcmd <pid> JDK.checkpoint
----

这将创建应用程序状态的快照。
然后，您可以使用以下命令从该快照恢复：

[source,bash]
----
java -XX:CRaCRestoreFrom=<path-to-checkpoint>
----

[[checkpoint-restore-considerations]]
== 注意事项

使用检查点恢复时，需要注意一些事项：

*   **打开的文件和套接字**：在检查点期间，所有打开的文件和套接字都必须关闭。Infra 框架会自动处理其管理的资源，但您可能需要手动处理应用程序特定的资源。
*   **随机性和时间**：如果在检查点之前初始化了随机数生成器或缓存了时间戳，则它们在恢复后可能会过时或重复。您应该在 `afterRestore()` 钩子中刷新这些值。
*   **环境变化**：如果恢复环境与检查点环境显着不同（例如，不同的网络配置），则某些资源可能无法正常工作。
