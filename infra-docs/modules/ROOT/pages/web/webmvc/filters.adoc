[[filters]]
= 过滤器 Filters


The `today-web` module provides some useful filters:

* xref:web/webmvc/filters.adoc#filters-http-put[Form Data]
* xref:web/webmvc/filters.adoc#filters-shallow-etag[Shallow ETag]
* xref:web/webmvc/filters.adoc#filters-cors[CORS]



[[filters-http-put]]
== Form Data

Browsers can submit form data only through HTTP GET or HTTP POST but non-browser clients can also
use HTTP PUT, PATCH, and DELETE. The Servlet API requires `ServletRequest.getParameter{asterisk}()`
methods to support form field access only for HTTP POST.

The `today-web` module provides `FormContentFilter` to intercept HTTP PUT, PATCH, and DELETE
requests with a content type of `application/x-www-form-urlencoded`, read the form data from
the body of the request, and wrap the `MockRequest` to make the form data
available through the `ServletRequest.getParameter{asterisk}()` family of methods.



[[forwarded-headers]]
== Forwarded Headers

include::partial$web/forwarded-headers.adoc[]




[[filters-forwarded-headers-dispatcher]]
=== Dispatcher Types

In order to support xref:web/webmvc/mvc-ann-async.adoc[asynchronous requests] and error dispatches this
filter should be mapped with `DispatcherType.ASYNC` and also `DispatcherType.ERROR`.
If using TODAY Framework's `AbstractAnnotationConfigDispatcherServletInitializer`
(see xref:web/webmvc/mvc-core/container-config.adoc[Servlet Config]) all filters are automatically registered for all dispatch
types. However if registering the filter via `web.xml` or in Infra App via a
`FilterRegistrationBean` be sure to include `DispatcherType.ASYNC` and
`DispatcherType.ERROR` in addition to `DispatcherType.REQUEST`.



[[filters-shallow-etag]]
== Shallow ETag

The `ShallowEtagHeaderFilter` filter creates a "`shallow`" ETag by caching the content
written to the response and computing an MD5 hash from it. The next time a client sends,
it does the same, but it also compares the computed value against the `If-None-Match`
request header and, if the two are equal, returns a 304 (NOT_MODIFIED).

This strategy saves network bandwidth but not CPU, as the full response must be computed for each request.
State-changing HTTP methods and other HTTP conditional request headers such as `If-Match` and
`If-Unmodified-Since` are outside the scope of this filter. Other strategies at the controller level
can avoid the computation and have a broader support for HTTP conditional requests.
See xref:web/webmvc/mvc-caching.adoc[HTTP Caching].

This filter has a `writeWeakETag` parameter that configures the filter to write weak ETags
similar to the following: `W/"02a2d595e6ed9a0b24f027f2b63b134d6"` (as defined in
{rfc-site}/rfc7232#section-2.3[RFC 7232 Section 2.3]).

In order to support xref:web/webmvc/mvc-ann-async.adoc[asynchronous requests] this filter must be mapped
with `DispatcherType.ASYNC` so that the filter can delay and successfully generate an
ETag to the end of the last async dispatch. If using TODAY Framework's
`AbstractAnnotationConfigDispatcherServletInitializer` (see xref:web/webmvc/mvc-core/container-config.adoc[Servlet Config])
all filters are automatically registered for all dispatch types. However if registering
the filter via `web.xml` or in Infra App via a `FilterRegistrationBean` be sure to include
`DispatcherType.ASYNC`.



[[filters-cors]]
== CORS

Web MVC provides fine-grained support for CORS configuration through annotations on
controllers. However, when used with Infra Security, we advise relying on the built-in
`CorsFilter` that must be ordered ahead of Infra Security's chain of filters.

See the sections on xref:web/webmvc-cors.adoc[CORS] and the xref:web/webmvc-cors.adoc#mvc-cors-filter[CORS Filter] for more details.




