[[mvc-container-config]]
= Netty 配置

`infra-web-netty-server` 模块提供了基于 Netty 的嵌入式 Web 服务器实现。
它可以通过 `infra-starter-netty-server` 启动器自动配置，也可以通过直接使用 `NettyWebServerFactory` 进行编程式配置。

== 依赖引入

要使用 Netty 作为嵌入式容器，您需要添加 `infra-starter-netty-server` 依赖：

[source,groovy]
----
dependencies {
  implementation 'cn.taketoday:infra-starter-netty-server'
}
----

== 配置属性

您可以通过 `server.netty` 前缀的配置属性来定制 Netty 服务器的行为。
以下是一些常用的配置项：

|===
| 属性名 | 描述 | 默认值

| `server.netty.worker-threads`
| 用于处理 I/O 操作的工作线程数 (Child EventLoopGroup)。
| 核心数 * 2

| `server.netty.acceptor-threads`
| 用于接收连接的线程数 (Parent EventLoopGroup)。
| 1

| `server.netty.max-connection`
| 允许的最大连接数 (SOMAXCONN)。
| 系统默认值 (Windows: 200, 其他: 128)

| `server.netty.max-content-length`
| 请求体的最大长度。超过此限制将返回错误。
| 100MB

| `server.netty.max-chunk-size`
| 最大分块大小。
| 8KB

| `server.netty.initial-buffer-size`
| HTTP 请求解码的初始缓冲区大小。
| 128B

| `server.netty.max-header-size`
| HTTP 头的最大大小。
| 8KB

| `server.netty.max-initial-line-length`
| HTTP 请求行（第一行）的最大长度。
| 4096

| `server.netty.validate-headers`
| 是否启用头验证，以防止请求/响应拆分攻击。
| true

| `server.netty.connection-timeout`
| 连接超时时间。
| 无

| `server.netty.leak-detection`
| 资源泄漏检测级别 (DISABLED, SIMPLE, ADVANCED, PARANOID)。
| DISABLED
|===

=== 线程池配置

您可以自定义工作线程和接收线程的名称：

[source,yaml]
----
server:
  netty:
    worker-pool-name: "infra-netty-worker"
    acceptor-pool-name: "infra-netty-acceptor"
----

=== 优雅停机

Netty 服务器支持优雅停机，可以通过 `server.netty.shutdown` 配置相关参数：

[source,yaml]
----
server:
  netty:
    shutdown:
      quiet-period: 2 # 静默期（秒），在此期间如果没有新任务提交，则关闭
      timeout: 15     # 最大等待时间（秒），无论是否有任务提交，超过此时间强制关闭
----

== 编程式配置

如果您需要更细粒度的控制，可以注册一个 `WebServerFactoryCustomizer` bean 来定制 `NettyWebServerFactory`：

[source,java]
----
@Bean
public WebServerFactoryCustomizer<NettyWebServerFactory> nettyCustomizer() {
  return factory -> {
    factory.setPort(8088);
    factory.setWorkerThreadCount(10);
  };
}

@Bean
public ServerBootstrapCustomizer serverBootstrapCustomizer(){
  return bootstrap -> {
    bootstrap.option(ChannelOption.AUTO_READ, false);
  };
}

----

== 请求配置定制

您还可以通过 `NettyRequestConfigCustomizer` 定制请求配置：

[source,java]
----
@Bean
public NettyRequestConfigCustomizer requestConfigCustomizer() {
  return builder -> {
    builder.maxContentLength(DataSize.ofMegabytes(50).toBytes())
            .writerAutoFlush(false);
  };
}
----
