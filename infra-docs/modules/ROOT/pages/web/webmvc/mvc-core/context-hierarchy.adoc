[[mvc-context-hierarchy]]
= 上下文层次结构

`MockDispatcher` 期望一个 `WebApplicationContext`（普通 `ApplicationContext` 的扩展）
来进行自己的配置。`WebApplicationContext` 拥有指向 `MockContextImpl` 和与其关联的 `MockApi` 的链接。
它也绑定到 `MockContextImpl`，以便应用程序如果需要访问它，可以使用 `RequestContextUtils` 上的静态方法来查找
`WebApplicationContext`。

对于许多应用程序来说，拥有单个 `WebApplicationContext` 很简单且足够。
也可以拥有一个上下文层次结构，其中一个根 `WebApplicationContext` 在多个 `MockDispatcher`
（或其他 `MockApi`）实例之间共享，每个实例都有自己的子 `WebApplicationContext` 配置。
有关上下文层次结构功能的更多信息，请参阅 xref:core/beans/context-introduction.adoc[`ApplicationContext` 的附加功能]。

根 `WebApplicationContext` 通常包含基础设施 bean，例如需要在多个 `MockApi` 实例之间共享的数据存储库和业务服务。
这些 bean 被有效地继承，并且可以在特定于 Servlet 的子 `WebApplicationContext` 中被覆盖（即重新声明），
子上下文通常包含给定 `MockApi` 本地的 bean。下图显示了这种关系：

image::mvc-context-hierarchy.png[]

以下示例配置了一个 `WebApplicationContext` 层次结构：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
public class MyWebAppInitializer extends AbstractAnnotationConfigDispatcherServletInitializer {

  @Override
  protected Class<?>[] getRootConfigClasses() {
    return new Class<?>[] { RootConfig.class };
  }

  @Override
  protected Class<?>[] getServletConfigClasses() {
    return new Class<?>[] { App1Config.class };
  }

  @Override
  protected String[] getServletMappings() {
    return new String[] { "/app1/*" };
  }
}
----
======

TIP: 如果不需要应用程序上下文层次结构，应用程序可以通过 `getRootConfigClasses()` 返回所有配置，
并从 `getServletConfigClasses()` 返回 `null`。

以下示例显示了等效的 `web.xml`：

[source,xml,indent=0,subs="verbatim,quotes"]
----
<web-app>

  <listener>
    <listener-class>infra.web.context.ContextLoaderListener</listener-class>
  </listener>

  <context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>/WEB-INF/root-context.xml</param-value>
  </context-param>

  <mockApi>
    <mockApi-name>app1</mockApi-name>
    <mockApi-class>infra.web.mockApi.DispatcherServlet</mockApi-class>
    <init-param>
      <param-name>contextConfigLocation</param-name>
      <param-value>/WEB-INF/app1-context.xml</param-value>
    </init-param>
    <load-on-startup>1</load-on-startup>
  </mockApi>

  <mockApi-mapping>
    <mockApi-name>app1</mockApi-name>
    <url-pattern>/app1/*</url-pattern>
  </mockApi-mapping>

</web-app>
----

TIP: 如果不需要应用程序上下文层次结构，应用程序可以仅配置“`root`”上下文，并将 `contextConfigLocation`
Servlet 参数留空。
