[[tx-propagation]]
= 事务传播

本节描述 Infra 中事务传播的一些语义。请注意，本节不是对事务传播的适当介绍。相反，它详细介绍了 Infra 中有关事务传播的一些语义。

在 Infra 管理的事务中，请注意物理事务和逻辑事务之间的区别，以及传播设置如何应用于此差异。

[[tx-propagation-required]]
== 理解 `PROPAGATION_REQUIRED`

image::tx_prop_required.png[]

`PROPAGATION_REQUIRED` 强制执行物理事务，如果尚未存在事务，则在本地为当前范围执行，或者参与为更大范围定义的现有“外部”事务。在同一线程内的常见调用堆栈安排中，这是一个很好的默认值（例如，委托给多个存储库方法的服务外观，其中所有底层资源都必须参与服务级事务）。

NOTE: 默认情况下，参与事务加入外部范围的特征，静默忽略本地隔离级别、超时值或只读标志（如果有）。如果您希望在参与具有不同隔离级别的现有事务时拒绝隔离级别声明，请考虑将事务管理器上的 `validateExistingTransactions` 标志切换为 `true`。这种非宽松模式还会拒绝只读不匹配（即尝试参与只读外部范围的内部读写事务）。

当传播设置是 `PROPAGATION_REQUIRED` 时，将为应用该设置的每个方法创建一个逻辑事务范围。每个这样的逻辑事务范围都可以单独确定仅回滚状态，外部事务范围在逻辑上独立于内部事务范围。在标准 `PROPAGATION_REQUIRED` 行为的情况下，所有这些范围都映射到同一个物理事务。因此，在内部事务范围中设置的仅回滚标记确实会影响外部事务实际提交的机会。

但是，在内部事务范围设置仅回滚标记的情况下，外部事务尚未决定回滚本身，因此回滚（由内部事务范围静默触发）是意外的。此时会抛出相应的 `UnexpectedRollbackException`。这是预期的行为，以便事务的调用者永远不会被误导以为实际上并未执行提交。因此，如果内部事务（外部调用者不知道）静默地将事务标记为仅回滚，则外部调用者仍然调用提交。外部调用者需要接收 `UnexpectedRollbackException` 以清楚地指示已执行回滚。

[[tx-propagation-requires_new]]
== 理解 `PROPAGATION_REQUIRES_NEW`

image::tx_prop_requires_new.png[]

与 `PROPAGATION_REQUIRED` 相比，`PROPAGATION_REQUIRES_NEW` 始终为每个受影响的事务范围使用独立的物理事务，从不参与外部范围的现有事务。在这种安排中，底层资源事务是不同的，因此可以独立提交或回滚，外部事务不受内部事务回滚状态的影响，内部事务的锁在其完成后立即释放。这种独立的内部事务还可以声明自己的隔离级别、超时和只读设置，而不继承外部事务的特征。

NOTE: 附加到外部事务的资源将保持绑定在那里，而内部事务获取其自己的资源，例如新的数据库连接。这可能导致连接池耗尽，如果多个线程具有活动的外部事务并等待获取其内部事务的新连接，并且池无法再分发任何此类内部连接，则可能导致死锁。除非您的连接池大小适当，超过并发线程数至少 1，否则请勿使用 `PROPAGATION_REQUIRES_NEW`。

[[tx-propagation-nested]]
== 理解 `PROPAGATION_NESTED`

`PROPAGATION_NESTED` 使用具有多个保存点的单个物理事务，它可以回滚到这些保存点。这种部分回滚允许内部事务范围触发其范围的回滚，尽管某些操作已回滚，但外部事务仍能够继续物理事务。此设置通常映射到 JDBC 保存点，因此它仅适用于 JDBC 资源事务。请参阅 Infra {today-framework-api}/jdbc/datasource/DataSourceTransactionManager.html[`DataSourceTransactionManager`]。
