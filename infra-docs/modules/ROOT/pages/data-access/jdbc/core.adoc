[[jdbc-core]]
= 使用 JDBC 核心类控制基本 JDBC 处理和错误处理

本节涵盖如何使用 JDBC 核心类来控制基本的 JDBC 处理，包括错误处理。它包括以下主题：

* xref:data-access/jdbc/core.adoc#jdbc-JdbcTemplate[使用 `JdbcTemplate`]
* xref:data-access/jdbc/core.adoc#jdbc-NamedParameterJdbcTemplate[使用 `NamedParameterJdbcTemplate`]
* xref:data-access/jdbc/core.adoc#jdbc-JdbcClient[统一 JDBC 查询/更新操作：`JdbcClient`]
* xref:data-access/jdbc/core.adoc#jdbc-SQLExceptionTranslator[使用 `SQLExceptionTranslator`]
* xref:data-access/jdbc/core.adoc#jdbc-statements-executing[运行语句]
* xref:data-access/jdbc/core.adoc#jdbc-statements-querying[运行查询]
* xref:data-access/jdbc/core.adoc#jdbc-updates[更新数据库]
* xref:data-access/jdbc/core.adoc#jdbc-auto-generated-keys[检索自动生成的键]


[[jdbc-JdbcTemplate]]
== 使用 `JdbcTemplate`

`JdbcTemplate` 是 JDBC 核心包中的中心类。它处理资源的创建和释放，这有助于您避免常见错误，例如忘记关闭连接。它执行核心 JDBC 工作流的基本任务（例如语句创建和执行），让应用程序代码提供 SQL 并提取结果。`JdbcTemplate` 类：

* 运行 SQL 查询
* 更新语句和存储过程调用
* 执行对 `ResultSet` 实例的迭代以及返回参数值的提取。
* 捕获 JDBC 异常并将它们转换为在 `infra.dao` 包中定义的通用的、信息更丰富的异常层次结构。（请参阅 xref:data-access/dao.adoc#dao-exceptions[一致的异常层次结构]。）

当您在代码中使用 `JdbcTemplate` 时，您只需实现回调接口，为它们提供明确定义的契约。给定 `JdbcTemplate` 类提供的 `Connection`，`PreparedStatementCreator` 回调接口创建一个预处理语句，提供 SQL 和任何必要的参数。`CallableStatementCreator` 接口也是如此，它创建可调用语句。`RowCallbackHandler` 接口从 `ResultSet` 的每一行中提取值。

您可以通过使用 `DataSource` 引用直接实例化，在 DAO 实现中使用 `JdbcTemplate`，或者您可以在 Infra IoC 容器中配置它，并将其作为 bean 引用提供给 DAO。

NOTE: `DataSource` 应始终在 Infra IoC 容器中配置为 bean。在第一种情况下，bean 直接提供给服务；在第二种情况下，它提供给准备好的模板。

此类发出的所有 SQL 都在对应于模板实例的完全限定类名（通常为 `JdbcTemplate`，但如果您使用 `JdbcTemplate` 类的自定义子类，则可能不同）的类别下以 `DEBUG` 级别记录。

以下部分提供了 `JdbcTemplate` 用法的一些示例。这些示例并未列出 `JdbcTemplate` 公开的所有功能。有关这方面的信息，请参阅随附的 {today-framework-api}/jdbc/core/JdbcTemplate.html[javadoc]。

[[jdbc-JdbcTemplate-examples-query]]
=== 查询 (`SELECT`)

以下查询获取关系中的行数：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
int rowCount = this.jdbcTemplate.queryForObject("select count(*) from t_actor", Integer.class);
----

======

以下查询使用绑定变量：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
int countOfActorsNamedJoe = this.jdbcTemplate.queryForObject(
    "select count(*) from t_actor where first_name = ?", Integer.class, "Joe");
----
======


以下查询查找一个 `String`：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
String lastName = this.jdbcTemplate.queryForObject(
    "select last_name from t_actor where id = ?", String.class, 1212L);
----

======

以下查询查找并填充单个域对象：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
Actor actor = jdbcTemplate.queryForObject(
    "select first_name, last_name from t_actor where id = ?",
    (resultSet, rowNum) -> {
      Actor newActor = new Actor();
      newActor.setFirstName(resultSet.getString("first_name"));
      newActor.setLastName(resultSet.getString("last_name"));
      return newActor;
    },
    1212L);
----

======

以下查询查找并填充域对象列表：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
List<Actor> actors = this.jdbcTemplate.query(
    "select first_name, last_name from t_actor",
    (resultSet, rowNum) -> {
      Actor actor = new Actor();
      actor.setFirstName(resultSet.getString("first_name"));
      actor.setLastName(resultSet.getString("last_name"));
      return actor;
    });
----
======

如果最后两个代码片段实际上存在于同一个应用程序中，那么删除两个 `RowMapper` lambda 表达式中存在的重复项并将其提取到单个字段中是有意义的，然后可以根据需要由 DAO 方法引用该字段。例如，最好将前面的代码片段编写如下：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
private final RowMapper<Actor> actorRowMapper = (resultSet, rowNum) -> {
  Actor actor = new Actor();
  actor.setFirstName(resultSet.getString("first_name"));
  actor.setLastName(resultSet.getString("last_name"));
  return actor;
};

public List<Actor> findAllActors() {
  return this.jdbcTemplate.query("select first_name, last_name from t_actor", actorRowMapper);
}
----

======

[[jdbc-JdbcTemplate-examples-update]]
=== 使用 `JdbcTemplate` 进行更新（`INSERT`、`UPDATE` 和 `DELETE`）

您可以使用 `update(..)` 方法执行插入、更新和删除操作。参数值通常作为可变参数提供，或者作为对象数组提供。

以下示例插入一个新条目：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
this.jdbcTemplate.update(
    "insert into t_actor (first_name, last_name) values (?, ?)", "Leonor", "Watling");
----

======

以下示例更新现有条目：

[tabs]
======
Java::
+
[source,java,indent=0,subs="verbatim,quotes",role="primary"]
----
this.jdbcTemplate.update(
    "update t_actor set last_name = ? where id = ?", "Banjo", 5276L);
----

======

以下示例删除一个条目：
